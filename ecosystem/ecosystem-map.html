<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>African AI Ecosystem — Heatmap</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

  <style>
    :root { --bg:#0f172a; --card:#1e293b; --text:#e2e8f0; --accent:#60a5fa; }
    body { margin:0; font-family:'Segoe UI',sans-serif; background:var(--bg); color:var(--text); }
    header { background:linear-gradient(135deg,#1e293b,#0f172a); padding:3rem 1rem; text-align:center; }
    h1 { margin:0; font-size:2.8rem; color:var(--accent); }
    .subtitle { opacity:0.9; font-size:1.2rem; }

    nav.breadcrumb { background:#1e293b; padding:1rem; text-align:center; font-size:1.1rem; }
    nav.breadcrumb a { color:var(--accent); text-decoration:none; margin:0 .8rem; }

    #map { height:75vh; width:100%; border-radius:16px; margin:1.5rem 0; box-shadow:0 10px 30px rgba(0,0,0,0.5); }

    .controls {
      display:flex; flex-wrap:wrap; gap:1rem; justify-content:center; margin:1rem 0; padding:1rem;
      background:var(--card); border-radius:12px; max-width:1400px; margin-left:auto; margin-right:auto;
    }
    .controls input, .controls select {
      padding:.7rem 1rem; border:none; border-radius:8px; background:#334155; color:white; min-width:220px;
    }

    .legend {
      background:var(--card); padding:1rem; border-radius:12px; margin:1rem auto; max-width:600px;
      display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:0.8rem;
    }
    .legend-item { display:flex; align-items:center; font-size:0.9rem; }
    .legend-color { width:16px; height:16px; border-radius:50%; margin-right:0.5rem; }

    #error { background:#fee2e2; color:#991b1b; padding:1.5rem; border-radius:12px; text-align:center; margin:2rem; font-weight:bold; display:none; }

    @media (max-width:900px) { #map { height:60vh; } }
  </style>
</head>
<body>

  <header>
    <h1>African AI Ecosystem</h1>
    <p class="subtitle">Interactive Heatmap — Every Startup, Lab & Hub on the Continent</p>
  </header>

  <nav class=" pered">
    <a href="ecosystem-overview.html">Overview</a> •
    <a href="ecosystem-map.html">Heatmap</a> •
    <a href="ecosystem-readiness.html">Readiness</a> •
    <a href="ecosystem-network.html">Network</a> •
    <a href="ecosystem-investor.html">Investor Briefs</a>
  </nav>

  <div id="error"></div>

  <div class="controls">
    <input type="text" id="search" placeholder="Search organization, domain, country..." />
    <select id="typeFilter">
      <option value="">All Types</option>
    </select>
  </div>

  <div id="map"></div>

  <div class="legend" id="legend"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_PATH = "https://open-data-africa.github.io/datasets/Ecosystem.csv";
    const map = L.map('map').setView([6, 20], 3);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const markers = L.markerClusterGroup({
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true,
      maxClusterRadius: 60
    });

    // Rainbow color palette by Type
    const typeColors = {
      "Startup": "#FF6B6B",
      "Research Lab": "#A55EEA",
      "Research Institute": "#C56CF0",
      "Platform": "#4ECDC4",
      "Community": "#96CEB4",
      "Hub": "#FECA57",
      "Program": "#FF9FF3",
      "default": "#54A0FF"
    };

    let allData = [];
    const errorDiv = document.getElementById("error");

    function showError(msg) {
      errorDiv.innerHTML = `Error: ${msg}`;
      errorDiv.style.display = "block";
    }

    Papa.parse(CSV_PATH, {
      download: true,
      header: true,
      dynamicTyping: false,
      trimHeaders: true,
      skipEmptyLines: true,
      complete: function(res) {
        if (res.errors.length) { showError("CSV error: " + res.errors[0].message); return; }
        allData = res.data.filter(r => r && r.Name && r.Name.trim());
        if (allData.length === 0) { showError("No data found."); return; }

        populateTypeFilter();
        plotAllMarkers();
        buildLegend();
      },
      error: () => showError("Failed to load CSV")
    });

    function getColor(type) {
      return typeColors[type] || typeColors["default"];
    }

    function plotAllMarkers(filterType = "", searchQuery = "") {
      markers.clearLayers();
      const filtered = allData.filter(org => {
        const matchesType = !filterType || (org.Type || "").trim() === filterType;
        const matchesSearch = !searchQuery || JSON.stringify(org).toLowerCase().includes(searchQuery.toLowerCase());
        return matchesType && matchesSearch;
      });

      filtered.forEach(org => {
        const name = (org.Name || "").trim();
        const country = (org.Country || "").trim();
        const type = (org.Type || "").trim();
        const domain = (org.Domain || "").trim();
        const website = (org.Website || "#").trim();

        // Approximate coordinates by country (you can add real lat/lng later)
        const coords = getCountryCoords(country);
        if (!coords) return;

        const icon = L.divIcon({
          className: "custom-marker",
          html: `<div style="background:${getColor(type)}; width:14px; height:14px; border-radius:50%; border:3px solid white; box-shadow:0 0 8px rgba(0,0,0,0.5);"></div>`,
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        });

        const marker = L.marker(coords, { icon });
        marker.bindPopup(`
          <div style="min-width:200px;">
            <strong style="font-size:1.1rem;">${name}</strong><br>
            <small style="opacity:0.8;">${type} • ${domain}</small><br>
            <strong>${country}</strong><br><br>
            <a href="${website}" target="_blank" style="color:#60a5fa; font-weight:bold;">Visit Website</a>
          </div>
        `);
        markers.addLayer(marker);
      });

      map.addLayer(markers);
      if (filtered.length > 0) map.fitBounds(markers.getBounds().pad(0.3));
    }

    function populateTypeFilter() {
      const types = [...new Set(allData.map(r => (r.Type || "").trim()))].filter(Boolean).sort();
      const select = document.getElementById("typeFilter");
      types.forEach(t => select.add(new Option(t, t)));
    }

    function buildLegend() {
      const legend = document.getElementById("legend");
      Object.entries(typeColors).forEach(([type, color]) => {
        if (type === "default") return;
        legend.innerHTML += `
          <div class="legend-item">
            <div class="legend-color" style="background:${color};"></div>
            <span>${type}</span>
          </div>
        `;
      });
    }

    // Simple country → lat/lng lookup (add more as needed)
    function getCountryCoords(country) {
      const map = {
        "Kenya": [-1.2921, 36.8219],
        "Ethiopia": [8.9806, 38.7578],
        "Nigeria": [9.0765, 7.3986],
        "Ghana": [7.9465, -1.0232],
        "South Africa": [-30.5595, 22.9375],
        "Rwanda": [-1.9403, 29.8739],
        "Uganda": [1.3733, 32.2903],
        "Pan-Africa": [6, 20], // Center of Africa
        "Egypt": [26.8206, 30.8025],
        "Morocco": [31.7917, -7.0926]
      };
      return map[country] || null;
    }

    // Live search & filter
    document.getElementById("search").addEventListener("input", () => {
      plotAllMarkers(document.getElementById("typeFilter").value, document.getElementById("search").value);
    });
    document.getElementById("typeFilter").addEventListener("change", () => {
      plotAllMarkers(document.getElementById("typeFilter").value, document.getElementById("search").value);
    });
  </script>
</body>
</html>
