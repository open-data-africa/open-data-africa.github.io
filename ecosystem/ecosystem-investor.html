<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>African AI Ecosystem — Investor Briefs</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root { --bg:#0f172a; --card:#1e293b; --text:#e2e8f0; --accent:#60a5fa; }
    body { margin:0; font-family:'Segoe UI',sans-serif; background:var(--bg); color:var(--text); }
    header { background:linear-gradient(135deg,#1e293b,#0f172a); padding:3rem 1rem; text-align:center; }
    h1 { margin:0; font-size:2.8rem; color:var(--accent); }
    .subtitle { opacity:0.9; font-size:1.2rem; }

    nav.breadcrumb { background:#1e293b; padding:1rem; text-align:center; font-size:1.1rem; }
    nav.breadcrumb a { color:var(--accent); text-decoration:none; margin:0 .8rem; }

    main { max-width:1000px; margin:2rem auto; padding:0 1rem; }

    .controls {
      display:flex; gap:1rem; flex-wrap:wrap; justify-content:center; margin-bottom:2rem;
      background:var(--card); padding:1.5rem; border-radius:16px;
    }
    .controls select, .controls button {
      padding:.8rem 1.5rem; border:none; border-radius:12px; font-weight:600; cursor:pointer;
    }
    .controls select { background:#334155; color:white; min-width:280px; }
    .controls button { background:var(--accent); color:#0f172a; font-size:1rem; }

    .preview {
      background:var(--card); padding:2.5rem; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.4);
      margin-top:2rem; display:none;
    }
    .logo { width:90px; height:auto; margin-bottom:1.5rem; border-radius:8px; }
    .executive { background:rgba(96,165,250,0.1); padding:1.5rem; border-radius:12px; margin:1.5rem 0; border-left:4px solid var(--accent); }
    .executive strong { color:var(--accent); }
    .org-item { background:rgba(255,255,255,0.05); padding:1.2rem; border-radius:12px; margin:1rem 0; }
    .org-item strong { color:var(--accent); font-size:1.1rem; }
    .org-item a { color:#60a5fa; text-decoration:none; }

    .contact { margin-top:3rem; padding:2rem; background:rgba(255,255,255,0.05); border-radius:12px; text-align:center; }
    .contact a { color:var(--accent); font-weight:bold; font-size:1.1rem; }

    @media (max-width:900px) { .controls { flex-direction:column; } .controls select,.controls button { width:100%; } }
  </style>
</head>
<body>

  <header>
    <h1>African AI Ecosystem</h1>
    <p class="subtitle">Professional Investor Briefs — One-click PDF for any country</p>
  </header>

  <nav class="breadcrumb">
    <a href="ecosystem-overview.html">Overview</a> •
    <a href="ecosystem-map.html">Map</a> •
    <a href="ecosystem-readiness.html">Readiness</a> •
    <a href="ecosystem-network.html">Network</a> •
    <a href="ecosystem-investor.html">Investor Briefs</a>
  </nav>

  <main>
    <div class="controls">
      <select id="countrySelect">
        <option value="">Select a country to generate brief</option>
      </select>
      <button onclick="generatePDF()">Download PDF</button>
    </div>

    <div class="preview" id="preview">
      <img src="https://open-data-africa.github.io/assets/logo.png" alt="Logo" class="logo" onerror="this.style.display='none'">
      <h2 id="briefTitle">Country AI Ecosystem Brief</h2>
      <p><strong>Generated:</strong> <span id="genDate"></span> | <strong>Readiness Rank:</strong> <span id="rank">#—</span></p>

      <div class="executive">
        <strong>Executive Summary</strong><br><br>
        <strong>Total AI Organizations:</strong> <span id="orgCount">0</span><br>
        <strong>Startups:</strong> <span id="startupCount">0</span><br>
        <strong>Readiness Score:</strong> <span id="readinessScore">0</span>/100<br>
        <strong>Key Domains:</strong> <span id="keyDomains">—</span>
      </div>

      <h3 style="margin:2rem 0 1rem; color:var(--accent);">Active Organizations</h3>
      <div id="orgList"></div>

      <div class="contact">
        Interested in co-investment, partnerships, or policy support?<br>
        <a href="mailto:info@open-data-africa.org">Contact us → info@open-data-africa.org</a>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_PATH = "https://open-data-africa.github.io/datasets/Ecosystem.csv";
    let allData = [];

    Papa.parse(CSV_PATH, {
      download: true,
      header: true,
      complete: function(res) {
        allData = res.data.filter(r => r.Name && r.Name.trim());
        populateCountries();
        calculateReadinessScores(); // Pre-calculate for ranking
      }
    });

    // Readiness calculation (same as readiness page)
    let countryScores = {};
    function calculateReadinessScores() {
      const stats = {};
      allData.forEach(org => {
        const c = (org.Country || "").trim() || "Unknown";
        if (!stats[c]) stats[c] = { total: 0, research: 0, orgs: [] };
        stats[c].total++;
        stats[c].orgs.push(org);
        const type = (org.Type || "").toLowerCase();
        if (type.includes("research") || type.includes("lab") || type.includes("institute") || type.includes("education")) {
          stats[c].research++;
        }
      });
      countryScores = Object.entries(stats).map(([country, s]) => {
        const score = Math.min(100, s.total * 10 + s.research * 15);
        return { country, score, rank: 0, total: s.total, research: s.research, orgs: s.orgs };
      });
      countryScores.sort((a, b) => b.score - a.score);
      countryScores.forEach((c, i) => c.rank = i + 1);
    }

    function populateCountries() {
      const countries = [...new Set(allData.map(r => (r.Country || "").trim()))].filter(Boolean).sort();
      const select = document.getElementById("countrySelect");
      countries.forEach(c => select.add(new Option(c, c)));
      select.addEventListener("change", updatePreview);
    }

    function updatePreview() {
      const country = document.getElementById("countrySelect").value;
      const orgs = allData.filter(o => (o.Country || "").trim() === country);
      const preview = document.getElementById("preview");
      if (!country) { preview.style.display = "none"; return; }

      const stats = countryScores.find(s => s.country === country) || { score: 0, rank: "—", total: 0 };
      const startups = orgs.filter(o => (o.Type || "").toLowerCase().includes("startup")).length;
      const domains = [...new Set(orgs.map(o => o.Domain?.trim()).filter(Boolean))].slice(0, 5).join(", ");

      document.getElementById("briefTitle").textContent = `${country} AI Ecosystem Brief`;
      document.getElementById("genDate").textContent = new Date().toLocaleDateString();
      document.getElementById("rank").textContent = `#${stats.rank}`;
      document.getElementById("orgCount").textContent = orgs.length;
      document.getElementById("startupCount").textContent = startups;
      document.getElementById("readinessScore").textContent = stats.score.toFixed(0);
      document.getElementById("keyDomains").textContent = domains || "Various";

      document.getElementById("orgList").innerHTML = orgs.map(o => `
        <div class="org-item">
          <strong>${o.Name?.trim()}</strong><br>
          <small>${o.Type?.trim()} • ${o.Domain?.trim()}</small>
          ${o.Website ? `<br><a href="${o.Website}" target="_blank">Visit Website</a>` : ""}
        </div>
      `).join("");

      preview.style.display = "block";
    }

    function generatePDF() {
      const country = document.getElementById("countrySelect").value;
      if (!country) return alert("Please select a country first.");

      const orgs = allData.filter(o => (o.Country || "").trim() === country);
      const stats = countryScores.find(s => s.country === country) || { score: 0, rank: "—" };
      const startups = orgs.filter(o => (o.Type || "").toLowerCase().includes("startup")).length;
      const domains = [...new Set(orgs.map(o => o.Domain?.trim()).filter(Boolean))].slice(0, 5).join(", ");

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Logo (if exists)
      const logo = new Image();
      logo.crossOrigin = "anonymous";
      logo.src = "https://open-data-africa.github.io/assets/logo.png";

      const addContent = () => {
        if (logo.complete && logo.naturalHeight !== 0) {
          doc.addImage(logo, "PNG", 150, 10, 40, 40);
        }

        doc.setFontSize(20).setTextColor(96, 165, 250);
        doc.text(`${country} AI Ecosystem Brief`, 20, 30);

        doc.setFontSize(11).setTextColor(150, 150, 150);
        doc.text(`Generated: ${new Date().toLocaleDateString()} | Readiness Rank #${stats.rank} | Score ${stats.score.toFixed(0)}/100`, 20, 40);

        doc.setFontSize(12).setTextColor(226, 232, 240);
        doc.text(`Total Organizations: ${orgs.length}  |  Startups: ${startups}  |  Key Domains: ${domains || "Various"}`, 20, 55);

        let y = 75;
        orgs.forEach((org, i) => {
          if (y > 260) { doc.addPage(); y = 20; }
          doc.setFontSize(14).setTextColor(96, 165, 250);
          doc.text(`${i + 1}. ${org.Name?.trim()}`, 20, y); y += 8;
          doc.setFontSize(10).setTextColor(200, 200, 200);
          doc.text(`${org.Type?.trim()} • ${org.Domain?.trim()}`, 25, y); y += 8;
          if (org.Website) {
            doc.setTextColor(96, 165, 250);
            doc.textWithLink("Visit Website", 25, y, { url: org.Website });
            y += 10;
          } else y += 5;
        });

        doc.setFontSize(10).setTextColor(150, 150, 150);
        doc.text("Contact for co-investment & partnerships: info@open-data-africa.org", 20, 280);

        doc.save(`${country.replace(/ /g, "_")}_AI_Ecosystem_Brief.pdf`);
      };

      logo.onload = addContent;
      logo.onerror = addContent; // Generate even if logo fails
    }
  </script>
</body>
</html>
