<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>African AI Ecosystem — Overview Dashboard</title>

  <style>
    :root { --bg:#0f172a; --card:#1e293b; --text:#e2e8f0; --accent:#60a5fa; }
    body { margin:0; font-family:'Segoe UI',sans-serif; background:var(--bg); color:var(--text); line-height:1.6; }
    header { background:linear-gradient(135deg,#1e293b,#0f172a); padding:3rem 1rem; text-align:center; }
    h1 { margin:0; font-size:2.8rem; color:var(--accent); }
    .subtitle { opacity:0.9; font-size:1.2rem; }

    nav.breadcrumb { background:#1e293b; padding:1rem; text-align:center; font-size:1.1rem; }
    nav.breadcrumb a { color:var(--accent); text-decoration:none; margin:0 .8rem; }

    main { max-width:1400px; margin:2rem auto; padding:0 1rem; }

    .controls { display:flex; flex-wrap:wrap; gap:1rem; justify-content:center; margin-bottom:2rem; padding:1rem; background:var(--card); border-radius:12px; }
    .controls input, .controls select { padding:.7rem 1rem; border:none; border-radius:8px; background:#334155; color:white; min-width:200px; }

    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1.5rem; margin:2rem 0; }
    .stat-card { background:var(--card); padding:1.8rem; border-radius:16px; text-align:center; box-shadow:0 8px 25px rgba(0,0,0,.3); }
    .stat-card h3 { margin:0; font-size:2.8rem; color:var(--accent); }

    .charts-grid { display:grid; grid-template-columns:1fr 1fr; gap:2rem; margin-top:3rem; }
    .chart-container { background:var(--card); padding:1.5rem; border-radius:16px; box-shadow:0 8px 25px rgba(0,0,0,.3); }
    canvas { border-radius:12px; }

    #error { background:#fee2e2; color:#991b1b; padding:1.5rem; border-radius:12px; text-align:center; margin:2rem; font-weight:bold; display:none; }

    @media (max-width:900px) { .charts-grid { grid-template-columns:1fr; } }
  </style>
</head>
<body>

  <header>
    <h1>African AI Ecosystem</h1>
    <p class="subtitle">Live Overview Dashboard — Startups, Labs, Communities & Research</p>
  </header>

  <nav class="breadcrumb">
    <a href="ecosystem-overview.html">Overview</a> •
    <a href="ecosystem-map.html">Map</a> •
    <a href="ecosystem-readiness.html">Readiness</a> •
    <a href="ecosystem-network.html">Network</a> •
    <a href="ecosystem-investor.html">Investor Briefs</a>
  </nav>

  <main>
    <div id="error"></div>

    <div class="controls">
      <input type="text" id="search" placeholder="Search by name, domain, description..." />
      <select id="countryFilter"><option value="">All Countries</option></select>
      <select id="typeFilter"><option value="">All Types</option></select>
      <select id="domainFilter"><option value="">All Domains</option></select>
    </div>

    <div class="stats-grid">
      <div class="stat-card"><h3 id="total">0</h3><p>Total Organisations</p></div>
      <div class="stat-card"><h3 id="countries">0</h3><p>Countries</p></div>
      <div class="stat-card"><h3 id="startups">0</h3><p>Startups</p></div>
      <div class="stat-card"><h3 id="domains">0</h3><p>Domains</p></div>
    </div>

    <div class="charts-grid">
      <div class="chart-container"><canvas id="byDomain"></canvas></div>
      <div class="chart-container"><canvas id="byType"></canvas></div>
      <div class="chart-container" style="grid-column:1/-1;"><canvas id="byCountry"></canvas></div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const CSV_PATH = "https://open-data-africa.github.io/datasets/Ecosystem.csv";
    const rainbowColors = ["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FECA57","#FF9FF3","#54A0FF","#48DBFB","#1DD1A1","#FF9F43","#EE5A24","#C56CF0","#FFC048","#FF6348","#A55EEA","#32CCBC","#FFA502","#FF5252","#667EEA","#B2FF59","#FF8A80"];

    function getColors(count) {
      return Array.from({length: count}, (_, i) => rainbowColors[i % rainbowColors.length]);
    }

    // THIS IS THE KEY FIX — never let undefined or empty string slip through
    function clean(value) {
      return (value === null || value === undefined || value === "") ? "Unknown" : String(value).trim();
    }

    let data = [];
    const errorDiv = document.getElementById("error");

    function showError(msg) {
      errorDiv.innerHTML = `Error: ${msg}`;
      errorDiv.style.display = "block";
    }

    Papa.parse(CSV_PATH, {
      download: true,
      header: true,
      dynamicTyping: false,
      trimHeaders: true,
      skipEmptyLines: true,
      complete: function(res) {
        if (res.errors.length) { showError("CSV parsing error: " + res.errors.map(e => e.message).join("<br>")); return; }
        data = res.data.filter(r => r && r.Name && r.Name.trim().length > 0);
        if (data.length === 0) { showError("No valid rows found."); return; }
        populateFilters();
        updateDashboard(data);
      },
      error: function() { showError("Failed to download CSV."); }
    });

    function populateFilters() {
      const uniq = (arr) => [...new Set(arr.map(v => clean(v)).filter(v => v !== "Unknown"))].sort();
      const countries = uniq(data.map(r => r.Country));
      const types = uniq(data.map(r => r.Type));
      const domains = uniq(data.map(r => r.Domain));

      [["countryFilter", countries], ["typeFilter", types], ["domainFilter", domains]].forEach(([id, values]) => {
        const sel = document.getElementById(id);
        values.forEach(v => sel.add(new Option(v, v)));
      });
    }

    function updateDashboard(set) {
      document.getElementById("total").textContent = set.length;
      document.getElementById("countries").textContent = [...new Set(set.map(r => clean(r.Country)))].filter(v => v !== "Unknown").length;
      document.getElementById("startups").textContent = set.filter(r => clean(r.Type).toLowerCase().includes("startup")).length;
      document.getElementById("domains").textContent = [...new Set(set.map(r => clean(r.Domain)))].filter(v => v !== "Unknown").length;

      draw("byDomain", "bar", count(set,"Domain"), "By Domain", getColors);
      draw("byType", "doughnut", count(set,"Type"), "By Type", getColors);
      draw("byCountry", "bar", count(set,"Country"), "By Country", getColors);
    }

    function count(arr, key) {
      const map = {};
      arr.forEach(i => {
        const v = clean(i[key]);   // ← This guarantees no "undefined"
        map[v] = (map[v] || 0) + 1;
      });
      return Object.entries(map)
        .sort((a, b) => b[1] - a[1])
        .slice(0, key === "Country" ? 20 : 12);
    }

    let charts = {};
    function draw(id, type, dataArr, title, colorFn) {
      const ctx = document.getElementById(id).getContext("2d");
      if (charts[id]) charts[id].destroy();
      const colors = colorFn(dataArr.length);
      charts[id] = new Chart(ctx, {
        type,
        data: { labels: dataArr.map(d => d[0]), datasets: [{ data: dataArr.map(d => d[1]), backgroundColor: colors }] },
        options: {
          responsive: true,
          plugins: {
            legend: { display: type !== "doughnut", labels: { color: "#e2e8f0" } },
            title: { display: true, text: title, color: "#e2e8f0", font: { size: 18, weight: "bold" } }
          },
          animation: { duration: 1500 }
        }
      });
    }

    ["search","countryFilter","typeFilter","domainFilter"].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("input", filter);
      el.addEventListener("change", filter);
    });

    function filter() {
      const q = document.getElementById("search").value.toLowerCase();
      const c = document.getElementById("countryFilter").value;
      const t = document.getElementById("typeFilter").value;
      const d = document.getElementById("domainFilter").value;

      const filtered = data.filter(i => {
        const match = !q || Object.values(i).some(f => f && String(f).toLowerCase().includes(q));
        const valC = clean(i.Country);
        const valT = clean(i.Type);
        const valD = clean(i.Domain);
        return match && (!c || valC === c) && (!t || valT === t) && (!d || valD === d);
      });
      updateDashboard(filtered);
    }
  </script>
</body>
</html>
