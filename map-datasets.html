<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Open Data Africa — 3D Dataset Map</title>
  <script src="https://unpkg.com/globe.gl"></script>
  <style>
    body { margin:0; background:#000; overflow:hidden; font-family:'Segoe UI',sans-serif; }
    #globe { width:100vw; height:100vh; }
    
    .title {
      position:absolute; top:15px; left:50%; transform:translateX(-50%);
      color:#60a5fa; font-size:2.4rem; font-weight:bold; z-index:10;
      text-shadow:0 0 20px #60a5fa;
      letter-spacing:1.5px;
    }
    
    .controls {
      position:absolute; top:15px; right:15px; background:rgba(0,0,0,0.7);
      padding:1rem; border-radius:18px; z-index:10; backdrop-filter:blur(20px);
      border:1px solid rgba(96,165,250,0.3);
    }
    .btn {
      background:linear-gradient(45deg,#60a5fa,#a5b4fc); color:#000;
      border:none; padding:0.9rem 1.8rem; border-radius:15px; cursor:pointer;
      font-weight:bold; font-size:1rem; margin:0.5rem 0; width:100%;
      box-shadow:0 8px 20px rgba(96,165,250,0.4);
    }
    .btn:hover { transform:scale(1.05); }

    .panel {
      position:absolute; top:50%; right:20px; transform:translateY(-50%);
      width:420px; max-height:85vh; overflow-y:auto;
      background:rgba(15,23,42,0.98); padding:2rem; border-radius:20px;
      color:#e2e8f0; z-index:100; display:none;
      box-shadow:0 20px 60px rgba(0,0,0,0.8);
      border:2px solid #60a5fa;
    }
    .panel h2 { margin:0 0 1.5rem; color:#60a5fa; text-align:center; font-size:1.8rem; }
    .close { position:absolute; top:15px; right:25px; font-size:2rem; cursor:pointer; color:#60a5fa; }
    .dataset {
      background:rgba(255,255,255,0.05); padding:1.2rem; border-radius:12px; margin:1rem 0;
      border-left:4px solid #60a5fa;
    }
    .dataset strong { color:#60a5fa; }
    .dataset a {
      display:inline-block; margin-top:0.8rem; background:#60a5fa; color:#000;
      padding:0.6rem 1.2rem; border-radius:10px; text-decoration:none; font-weight:bold;
    }
  </style>
</head>
<body>

  <div class="title">Open Datasets 3D Map</div>

  <div class="controls">
    <button class="btn" id="toggleRotate">Pause Rotation</button>
  </div>

  <div id="globe"></div>

  <div class="panel" id="panel">
    <div class="close" onclick="document.getElementById('panel').style.display='none'">×</div>
    <h2 id="countryTitle">Select a country</h2>
    <div id="datasetList"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_PATH = "https://open-data-africa.github.io/datasets/catalog.csv";

    const globe = Globe()
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
      .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
      .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
      .showAtmosphere(true)
      .atmosphereColor('#60a5fa')
      .atmosphereAltitude(0.25)
      (document.getElementById('globe'));

    const coords = {
      "Kenya": [-1.29, 36.82], "Ethiopia": [9.02, 38.75], "Nigeria": [9.08, 7.40],
      "Ghana": [7.95, -1.02], "South Africa": [-30.56, 22.94], "Rwanda": [-1.94, 29.87],
      "Uganda": [1.37, 32.29], "Tanzania": [-6.79, 34.89], "Egypt": [26.82, 30.80],
      "Morocco": [31.79, -7.09], "Tunisia": [36.82, 10.17], "Senegal": [14.50, -14.45],
      "Côte d'Ivoire": [7.54, -5.55], "Cameroon": [3.85, 11.50], "Pan-Africa": [6, 20], "Global": [20, 0]
    };

    const domainColor = {
      "Agriculture": "#34d399", "Health": "#f87171", "Climate": "#60a5fa",
      "Environment": "#34d399", "Language": "#a78bfa", "NLP": "#a78bfa",
      "Finance": "#f59e0b", "Economy": "#f59e0b", "Geospatial": "#f472b6",
      "Education": "#fbbf24", "default": "#94a3b8"
    };

    let allDatasets = [];
    let countryGroups = {};

    Papa.parse(CSV_PATH, {
      download: true,
      header: true,
      complete: function(res) {
        allDatasets = res.data.filter(r => r["Dataset Name"] && r.Country);

        countryGroups = {};
        allDatasets.forEach(d => {
          const c = (d.Country || "Other").trim();
          if (!countryGroups[c]) countryGroups[c] = [];
          countryGroups[c].push(d);
        });

        const points = Object.entries(countryGroups).map(([country, datasets]) => {
          const color = domainColor[datasets[0].Domain] || domainColor.default;
          return {
            lat: coords[country]?.[0] || 6,
            lng: coords[country]?.[1] || 20,
            size: 0.8,
            color: color,
            country: country,
            datasets: datasets
          };
        });

        globe
          .pointsData(points)
          .pointAltitude(0.02)
          .pointColor(d => d.color)
          .pointRadius(d => d.size)
          .pointLabel(d => `<b>${d.country}</b><br>${d.datasets.length} dataset${d.datasets.length>1?'s':''}`)
          .onPointClick(point => showCountryPanel(point));

        // Start rotating + manual control
        const controls = globe.controls();
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.6;
        controls.enableZoom = true;
        controls.enablePan = true;

        document.getElementById('toggleRotate').addEventListener('click', function() {
          const rotating = controls.autoRotate;
          controls.autoRotate = !rotating;
          this.textContent = rotating ? "Resume Rotation" : "Pause Rotation";
        });
      }
    });

    function showCountryPanel(point) {
      const datasets = point.datasets;
      document.getElementById("countryTitle").textContent = 
        `${point.country} — ${datasets.length} Open Dataset${datasets.length>1?'s':''}`;

      document.getElementById("datasetList").innerHTML = datasets.map(d => `
        <div class="dataset">
          <strong>${d["Dataset Name"]}</strong><br>
          <small>${d.Domain} • ${d["Data Type"]} • ${d.License}</small><br>
          ${d["Use Cases"] ? `<p><em>${d["Use Cases"]}</em></p>` : ""}
          <a href="${d.Link}" target="_blank">Download Dataset</a>
        </div>
      `).join("");

      document.getElementById("panel").style.display = "block";
    }
  </script>
</body>
</html>
