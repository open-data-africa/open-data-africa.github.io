<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Open Data Africa — 3D Dataset Map</title>
  <script src="https://unpkg.com/globe.gl"></script>
  <style>
    body { margin:0; background:#000; overflow:hidden; font-family:'Segoe UI',sans-serif; }
    #globe { width:100vw; height:100vh; }
    .title {
      position:absolute; top:20px; left:50%; transform:translateX(-50%);
      color:#60a5fa; font-size:3.5rem; font-weight:bold; z-index:10;
      text-shadow:0 0 30px #60a5fa, 0 0 60px #60a5fa;
    }
    .controls {
      position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.7);
      padding:1.2rem; border-radius:20px; z-index:10; backdrop-filter:blur(20px);
      border:1px solid rgba(96,165,250,0.3);
    }
    .btn {
      background:linear-gradient(45deg,#60a5fa,#a5b4fc); color:#000;
      border:none; padding:0.9rem 1.8rem; border-radius:15px; cursor:pointer;
      font-weight:bold; font-size:1rem; margin:0.5rem 0; width:100%;
      box-shadow:0 8px 20px rgba(96,165,250,0.4);
    }
    .btn:hover { transform:scale(1.05); }
    .filter {
      padding:0.8rem; border-radius:12px; background:#334155; color:white; border:none;
      margin:0.5rem 0; width:100%; font-size:0.95rem;
    }
    .info {
      position:absolute; bottom:20px; left:20px; background:rgba(0,0,0,0.7);
      padding:1.5rem 2rem; border-radius:20px; color:#e2e8f0; max-width:420px;
      backdrop-filter:blur(20px); border:1px solid rgba(96,165,250,0.3);
    }
  </style>
</head>
<body>

  <div class="title">OPEN DATASETS 3D MAP</div>

  <div class="controls">
    <input type="text" id="search" class="filter" placeholder="Search dataset..." />
    <select id="domainFilter" class="filter"><option value="">All Domains</option></select>
    <select id="countryFilter" class="filter"><option value="">All Countries</option></select>
    <button class="btn" id="toggleRotate">Pause Rotation</button>
  </div>

  <div id="globe"></div>

  <div class="info">
    <strong>Click any glowing point → View full dataset</strong><br>
    Drag • Zoom • Explore Africa's open data universe
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_PATH = "https://open-data-africa.github.io/datasets/catalog.csv";

    // Bright, beautiful Earth
    const globe = Globe()
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
      .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
      .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
      .showAtmosphere(true)
      .atmosphereColor('#60a5fa')
      .atmosphereAltitude(0.25)
      (document.getElementById('globe'));

    // Coordinates for countries
    const coords = {
      "Kenya": [-1.29, 36.82], "Ethiopia": [9.02, 38.75], "Nigeria": [9.08, 7.40],
      "Ghana": [7.95, -1.02], "South Africa": [-30.56, 22.94], "Rwanda": [-1.94, 29.87],
      "Uganda": [1.37, 32.29], "Tanzania": [-6.79, 34.89], "Egypt": [26.82, 30.80],
      "Morocco": [31.79, -7.09], "Algeria": [28.03, 1.66], "Tunisia": [36.82, 10.17],
      "Senegal": [14.50, -14.45], "Côte d'Ivoire": [7.54, -5.55], "Cameroon": [3.85, 11.50],
      "Pan-Africa": [6, 20], "Global": [20, 0]
    };

    // Color by Domain
    const domainColor = {
      "Agriculture": "#34d399",
      "Health": "#f87171",
      "Climate": "#60a5fa",
      "Environment": "#34d399",
      "Language": "#a78bfa",
      "NLP": "#a78bfa",
      "Finance": "#f59e0b",
      "Economy": "#f59e0b",
      "Geospatial": "#f472b6",
      "Education": "#fbbf24",
      "default": "#94a3b8"
    };

    let allDatasets = [];

    Papa.parse(CSV_PATH, {
      download: true,
      header: true,
      complete: function(res) {
        allDatasets = res.data.filter(r => r["Dataset Name"] && r.Country);

        // Populate filters
        const domains = [...new Set(allDatasets.map(r => r.Domain))].filter(Boolean).sort();
        const countries = [...new Set(allDatasets.map(r => r.Country))].filter(Boolean).sort();
        document.getElementById("domainFilter").innerHTML += domains.map(d => `<option>${d}</option>`).join("");
        document.getElementById("countryFilter").innerHTML += countries.map(c => `<option>${c}</option>`).join("");

        updateGlobe();
      }
    });

    function updateGlobe() {
      const search = document.getElementById("search").value.toLowerCase();
      const domain = document.getElementById("domainFilter").value;
      const country = document.getElementById("countryFilter").value;

      const filtered = allDatasets.filter(d => {
        const match = !search || Object.values(d).some(v => v && v.toLowerCase().includes(search));
        return match && (!domain || d.Domain === domain) && (!country || d.Country === country);
      });

      const points = filtered.map(d => ({
        lat: coords[d.Country]?.[0] || coords["Pan-Africa"][0],
        lng: coords[d.Country]?.[1] || coords["Pan-Africa"][1],
        size: 1.2,
        color: domainColor[d.Domain] || domainColor.default,
        dataset: d
      }));

      globe
        .pointsData(points)
        .pointAltitude(0.05)
        .pointColor(d => d.color)
        .pointRadius(d => d.size)
        .pointLabel(d => `
          <div style="background:rgba(0,0,0,0.95); padding:16px; border-radius:16px; border:2px solid ${d.color}; max-width:300px; font-size:14px;">
            <b style="color:${d.color};">${d.dataset["Dataset Name"]}</b><br><br>
            <strong>Domain:</strong> ${d.dataset.Domain}<br>
            <strong>Source:</strong> ${d.dataset.Source}<br>
            <strong>Country:</strong> ${d.dataset.Country}<br>
            <strong>Type:</strong> ${d.dataset["Data Type"]}<br>
            <strong>License:</strong> ${d.dataset.License}<br>
            <strong>Use Cases:</strong> ${d.dataset["Use Cases"]}<br>
            <strong>Last Updated:</strong> ${d.dataset["Last Updated"]}<br>
            ${d.dataset["Challenges/Notes"] ? `<strong>Notes:</strong> ${d.dataset["Challenges/Notes"]}<br>` : ""}
            <a href="${d.dataset.Link}" target="_blank" style="color:${d.color}; font-weight:bold; margin-top:10px; display:block;">Download Dataset</a>
          </div>
        `)
        .onPointClick(point => window.open(point.dataset.Link, '_blank'));
    }

    // Filters
    document.getElementById("search").addEventListener("input", updateGlobe);
    document.getElementById("domainFilter").addEventListener("change", updateGlobe);
    document.getElementById("countryFilter").addEventListener("change", updateGlobe);

    // Rotation control
    globe.controls().autoRotate = true;
    globe.controls().autoRotateSpeed = 0.6;
    document.getElementById('toggleRotate').addEventListener('click', function() {
      const rotating = globe.controls().autoRotate;
      globe.controls().autoRotate = !rotating;
      this.textContent = rotating ? "Resume Rotation" : "Pause Rotation";
    });
  </script>
</body>
</html>
