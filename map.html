<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Africa Open Data Map</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin:0; }
    #container { display: flex; flex-direction: row; height: 90vh; }
    #map { flex: 1; }
    #details { flex: 1; overflow-y: auto; padding: 1rem; border-left: 1px solid #ddd; background: #f9f9f9; }
    h2 { margin-top: 0; }
    .dataset-item { margin-bottom: 0.8rem; }
    .dataset-item a { color: #0077cc; text-decoration: none; }
    .dataset-item a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <h1 style="text-align:center; padding:1rem;">üåç Africa Open Data Map</h1>
  <div id="container">
    <div id="map"></div>
    <div id="details">
      <p>Click a country to see available datasets.</p>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    let catalogData = [];
    let countryDatasetCounts = {};
    let map;

    // 1. Load CSV
    fetch("datasets/catalog.csv")
      .then(res => res.text())
      .then(csv => parseCSV(csv))
      .then(data => {
        catalogData = data;
        countDatasetsByCountry();
        initMap();
      });

    // 2. Parse CSV
    function parseCSV(text) {
      const rows = text.trim().split("\n");
      const headers = rows[0].split("\t").map(h => h.trim());

      return rows.slice(1).map(row => {
        const cols = row.split("\t");
        let obj = {};
        headers.forEach((h,i)=> obj[h] = cols[i] ? cols[i].trim() : "");
        return obj;
      });
    }

    // 3. Normalize country names
    function normalize(str){
      if(!str) return "";
      return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z ]/g,"").replace(/\s+/g," ").trim();
    }

    // 4. Count datasets per country
    function countDatasetsByCountry(){
      catalogData.forEach(row=>{
        const c = normalize(row.Country);
        if(!countryDatasetCounts[c]) countryDatasetCounts[c]=0;
        countryDatasetCounts[c]++;
      });
    }

    // 5. Color scale
    function getColor(count){
      return count>30? '#800026':
             count>20? '#BD0026':
             count>10? '#E31A1C':
             count>5?  '#FC4E2A':
             count>2?  '#FD8D3C':
             count>0?  '#FED976':'#ccc';
    }

    function style(feature){
      const key = normalize(feature.properties.ADMIN);
      const count = countryDatasetCounts[key] || 0;
      return { fillColor: getColor(count), weight:1, color:'#666', fillOpacity:0.85 };
    }

    // 6. Country click handler
    function countryClick(e){
      const layer = e.target;
      const countryName = layer.feature.properties.ADMIN;
      const key = normalize(countryName);

      const datasets = catalogData.filter(d => normalize(d.Country)===key);

      let html = `<h2>${countryName}</h2>`;
      html += `<p><strong>${datasets.length}</strong> dataset(s) available.</p>`;

      if(datasets.length===0){
        html += "<p>No datasets available for this country.</p>";
      } else {
        datasets.forEach(ds=>{
          html += `<div class="dataset-item">
                     <strong>${ds["Dataset Name"]}</strong><br>
                     <a href="${ds.Link}" target="_blank">Open dataset</a>
                   </div>`;
        });
      }

      document.getElementById("details").innerHTML = html;
    }

    // 7. Tooltip
    function onEachFeature(feature, layer){
      const key = normalize(feature.properties.ADMIN);
      const count = countryDatasetCounts[key]||0;
      layer.bindTooltip(`${feature.properties.ADMIN}: ${count} dataset(s)`);
      layer.on({ click: countryClick });
    }

    // 8. Initialize map
    function initMap(){
      map = L.map("map").setView([7,20], 3);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:6}).addTo(map);

      fetch("geojson/africa.geojson")
        .then(res=>res.json())
        .then(json=>{
          L.geoJSON(json,{style:style,onEachFeature:onEachFeature}).addTo(map);
        });
    }
  </script>
</body>
</html>
