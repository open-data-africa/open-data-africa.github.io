<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Africa Data Map – Open Data Africa</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #fafafa;
    }

    h1 {
        text-align: center;
        margin-top: 20px;
    }

    #map {
        height: 480px;
        width: 100%;
        margin-bottom: 20px;
    }

    .container {
        width: 90%;
        margin: auto;
    }

    input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 2px solid #444;
        border-radius: 4px;
        margin-bottom: 15px;
        font-size: 16px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 40px;
        background: white;
    }

    th, td {
        padding: 10px;
        border: 1px solid #ddd;
    }

    th {
        background: #333;
        color: white;
    }

    a {
        color: #0066cc;
        text-decoration: none;
    }

    a:hover {
        text-decoration: underline;
    }

    .popup-title {
        font-weight: bold;
        margin-bottom: 5px;
        display: block;
    }
</style>
</head>

<body>

<h1>Interactive Africa Data Map</h1>

<div id="map"></div>

<div class="container">
    <input type="text" id="searchInput" placeholder="Search datasets or countries..." />

    <table id="datasetTable">
        <thead>
            <tr>
                <th>Dataset Name</th>
                <th>Country</th>
                <th>Domain</th>
                <th>Link</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
// -------------------------------
// Leaflet Map Setup
// -------------------------------
const map = L.map('map').setView([0.5, 20], 3);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 6
}).addTo(map);

let markers = [];
let datasetRows = [];
let catalogData = [];


// -------------------------------
// Load catalog.csv
// -------------------------------
fetch("datasets/catalog.csv")
    .then(response => response.text())
    .then(csv => parseCSV(csv))
    .then(data => {
        catalogData = data;
        placeCountryMarkers(data);
        populateTable(data);
    });


// -------------------------------
// CSV Parser
// -------------------------------
function parseCSV(text) {
    const rows = text.trim().split("\n");
    const headers = rows[0].split(",").map(h => h.trim());
    const data = [];

    for (let i = 1; i < rows.length; i++) {
        const cols = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        const entry = {};

        headers.forEach((h, index) => {
            entry[h] = cols[index] ? cols[index].replace(/"/g, "").trim() : "";
        });

        data.push(entry);
    }

    return data;
}


// -------------------------------
// Add dot markers for all countries
// -------------------------------
function placeCountryMarkers(data) {

    // Lookup table for country centroids (simple)
    const countryCoords = {
        "Ethiopia": [9.145, 40.489],
        "Kenya": [-0.0236, 37.9062],
        "Nigeria": [9.082, 8.6753],
        "Ghana": [7.9465, -1.0232],
        "Uganda": [1.3733, 32.2903],
        "Tanzania": [-6.3690, 34.8888],
        "South Africa": [-30.5595, 22.9375],
        "Rwanda": [-1.9403, 29.8739],
        "Senegal": [14.4974, -14.4524],
        "Egypt": [26.8206, 30.8025],
        "Morocco": [31.7917, -7.0926],
        "Zimbabwe": [-19.0154, 29.1549],
        "Botswana": [-22.3285, 24.6849],
        "Zambia": [-13.1339, 27.8493],
        "Cameroon": [7.3697, 12.3547]
    };

    // Group datasets by country
    const grouped = {};
    data.forEach(d => {
        if (!grouped[d.Country]) grouped[d.Country] = [];
        grouped[d.Country].push(d);
    });

    Object.keys(grouped).forEach(country => {
        if (!countryCoords[country]) return; // skip unmapped countries

        const marker = L.circleMarker(countryCoords[country], {
            radius: 7,
            color: "#d33",
            fillColor: "#d33",
            fillOpacity: 0.8
        }).addTo(map);

        const popupHtml = `
            <span class="popup-title">${country}</span>
            <ul>
                ${grouped[country].map(ds => `
                    <li><a href="${ds.Link}" target="_blank">${ds.Dataset}</a></li>
                `).join("")}
            </ul>
        `;

        marker.bindPopup(popupHtml);
        marker.country = country;

        markers.push(marker);
    });
}


// -------------------------------
// Populate the table
// -------------------------------
function populateTable(data) {
    const tbody = document.querySelector("#datasetTable tbody");
    tbody.innerHTML = "";

    data.forEach(d => {
        const row = document.createElement("tr");
        row.dataset.country = d.Country.toLowerCase();

        row.innerHTML = `
            <td>${d.Dataset}</td>
            <td>${d.Country}</td>
            <td>${d.Domain}</td>
            <td><a href="${d.Link}" target="_blank">Open</a></td>
        `;

        tbody.appendChild(row);
        datasetRows.push(row);
    });
}


// -------------------------------
// Live Search Filter → Table + Map
// -------------------------------
document.getElementById("searchInput").addEventListener("input", function () {
    const text = this.value.toLowerCase();

    // filter table rows
    datasetRows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(text) ? "" : "none";
    });

    // detect visible countries based on table
    const visibleCountries = new Set(
        datasetRows
            .filter(row => row.style.display !== "none")
            .map(row => row.dataset.country)
    );

    // update map markers
    markers.forEach(m => {
        m.setStyle({
            opacity: visibleCountries.size === 0 || visibleCountries.has(m.country.toLowerCase())
                ? 1 : 0.2,
            fillOpacity: visibleCountries.size === 0 || visibleCountries.has(m.country.toLowerCase())
                ? 0.9 : 0.1
        });
    });
});
</script>

</body>
</html>
