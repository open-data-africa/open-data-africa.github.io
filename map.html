<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Africa Data Map â€“ Master Detail Dashboard</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #fafafa;
    }

    #container {
        display: flex;
        height: 100vh;
    }

    /* LEFT PANEL MAP */
    #map {
        flex: 2;
        height: 100%;
    }

    /* RIGHT PANEL DETAILS */
    #details {
        flex: 1;
        background: white;
        padding: 20px;
        overflow-y: auto;
        border-left: 2px solid #ddd;
    }

    h2 {
        margin-top: 0;
    }

    .dataset-item {
        margin-bottom: 10px;
    }

    a {
        color: #0077cc;
        text-decoration: none;
    }
</style>

</head>
<body>

<div id="container">
    <div id="map"></div>

    <div id="details">
        <h2>Click a country</h2>
        <p>Select a country on the map to view available datasets.</p>
    </div>
</div>

<script>
// ----------------------------------------
// GLOBAL VARIABLES
// ----------------------------------------
let catalogData = [];
let countryDatasetCounts = {};
let map;
let geojsonLayer;

// ----------------------------------------
// LOAD CSV FIRST
// ----------------------------------------
fetch("datasets/catalog.csv")
    .then(res => res.text())
    .then(csv => parseCSV(csv))
    .then(data => {
        catalogData = data;
        countDatasetsByCountry();
        initMap();
    });

// ----------------------------------------
// CSV PARSER
// ----------------------------------------
function parseCSV(text) {
    const rows = text.trim().split("\n");
    const headers = rows[0].split(",").map(h => h.trim());
    const data = [];

    for (let i = 1; i < rows.length; i++) {
        const cols = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        const obj = {};
        headers.forEach((h, idx) => {
            obj[h] = cols[idx] ? cols[idx].replace(/"/g, "").trim() : "";
        });
        data.push(obj);
    }
    return data;
}

// ----------------------------------------
// COUNT DATASETS PER COUNTRY
// ----------------------------------------
function countDatasetsByCountry() {
    catalogData.forEach(d => {
        const c = d.Country.trim();
        if (!countryDatasetCounts[c]) countryDatasetCounts[c] = 0;
        countryDatasetCounts[c]++;
    });
}

// ----------------------------------------
// COLOR SCALE FOR CHOROPLETH
// ----------------------------------------
function getColor(count) {
    return count > 30 ? '#800026' :
           count > 20 ? '#BD0026' :
           count > 10 ? '#E31A1C' :
           count > 5  ? '#FC4E2A' :
           count > 2  ? '#FD8D3C' :
           count > 0  ? '#FED976' :
                        '#ccc';      // no datasets
}

// ----------------------------------------
// STYLE COUNTRY SHAPE
// ----------------------------------------
function style(feature) {
    let name = feature.properties.ADMIN;
    let count = countryDatasetCounts[name] || 0;

    return {
        fillColor: getColor(count),
        weight: 1,
        opacity: 1,
        color: '#555',
        fillOpacity: 0.8
    };
}

// ----------------------------------------
// COUNTRY CLICK HANDLER
// ----------------------------------------
function countryClick(e) {
    const layer = e.target;
    const country = layer.feature.properties.ADMIN;

    const datasets = catalogData.filter(d => d.Country === country);

    let html = `<h2>${country}</h2>`;
    html += `<p><strong>${datasets.length}</strong> datasets available.</p>`;

    if (datasets.length === 0) {
        html += "<p>No datasets available for this country.</p>";
    } else {
        datasets.forEach(ds => {
            html += `
                <div class="dataset-item">
                    <strong>${ds.Dataset}</strong><br>
                    <a href="${ds.Link}" target="_blank">Open dataset</a>
                </div>
            `;
        });
    }

    document.getElementById("details").innerHTML = html;
}

// ----------------------------------------
// HOVER TOOLTIP
// ----------------------------------------
function onEachFeature(feature, layer) {
    const name = feature.properties.ADMIN;
    const count = countryDatasetCounts[name] || 0;

    layer.bindTooltip(`${name}: ${count} dataset(s)`);

    layer.on({
        click: countryClick
    });
}

// ----------------------------------------
// INITIALIZE MAP
// ----------------------------------------
function initMap() {
    map = L.map("map").setView([7, 20], 3);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 6
    }).addTo(map);

    fetch("geojson/africa.geojson")
        .then(res => res.json())
        .then(json => {
            geojsonLayer = L.geoJSON(json, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(map);
        });
}
</script>

</body>
</html>
