<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dataset Map â€“ Open Data Africa</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    body {
      background: #f8f9fa;
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #004e64;
    }

    #map {
      width: 100%;
      height: 600px;
      margin: 30px auto;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    #countryData {
      margin-top: 20px;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    table th, table td {
      border: 1px solid #ddd;
      padding: 10px;
    }

    table th {
      background: #004e64;
      color: #fff;
      text-align: left;
    }
  </style>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

</head>
<body>

<h1>Explore African Datasets by Country</h1>

<div id="map"></div>

<div id="countryData">
  <h2>Click a country to view datasets</h2>
  <div id="datasetCount"></div>
  <table id="datasetTable"></table>
</div>

<script>
// =========================
// 1. Load CSV Data
// =========================
let allDatasets = [];
let countryIndex = {};

Papa.parse("datasets/catalog.csv", {
    download: true,
    header: true,
    complete: function(results) {
        allDatasets = results.data;

        // normalize & index by country
        allDatasets.forEach(d => {
            // normalize
            let c = (d.Country || d.CountryRegion || "").trim().toLowerCase();

            if (!countryIndex[c]) countryIndex[c] = [];
            countryIndex[c].push(d);
        });
    }
});

// =========================
// 2. Draw Map
// =========================
let map = L.map('map').setView([0, 20], 3);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 5,
    minZoom: 2
}).addTo(map);

// Load Africa GeoJSON
fetch("https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson")
  .then(res => res.json())
  .then(geo => {
    L.geoJSON(geo, { 
      style: {
        weight: 1,
        color: "#555",
        fillColor: "#89c2d9",
        fillOpacity: 0.45
      },
      onEachFeature: function(feature, layer) {
        let name = feature.properties.ADMIN;

        // highlight on hover
        layer.on("mouseover", () => layer.setStyle({ fillOpacity: 0.8 }));
        layer.on("mouseout", () => layer.setStyle({ fillOpacity: 0.45 }));

        // CLICK EVENT
        layer.on("click", () => loadCountry(name));
      }
    }).addTo(map);
  });

// =========================
// 3. COUNTRY CLICK HANDLER
// =========================
function loadCountry(countryName) {
    document.getElementById("countryData").scrollIntoView({ behavior: "smooth" });

    let key = countryName.trim().toLowerCase();

    // direct match
    let datasets = countryIndex[key];

    // fallback: partial match
    if (!datasets) {
      datasets = countryIndex[
        Object.keys(countryIndex).find(k => key.includes(k) || k.includes(key))
      ];
    }

    // still nothing: no datasets
    if (!datasets) datasets = [];

    document.getElementById("datasetCount").innerHTML = `
      <h2>${countryName}</h2>
      <p><strong>${datasets.length}</strong> datasets found</p>
    `;

    // build table
    if (datasets.length === 0) {
      document.getElementById("datasetTable").innerHTML = "<tr><td>No datasets available.</td></tr>";
      return;
    }

    let html = `
      <tr>
        <th>Dataset Name</th>
        <th>Domain</th>
        <th>Source</th>
        <th>Access</th>
      </tr>
    `;

    datasets.forEach(d => {
      html += `
        <tr>
          <td>${d.DatasetName || ""}</td>
          <td>${d.Domain || ""}</td>
          <td>${d.SourceOwner || ""}</td>
          <td>${d.AccessLevel || ""}</td>
        </tr>
      `;
    });

    document.getElementById("datasetTable").innerHTML = html;
}

</script>
</body>
</html>
