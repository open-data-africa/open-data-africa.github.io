<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Africa Open Data Map – Open Data Africa</title>
<link rel="stylesheet" href="style.css">
<style>
  body { font-family: Arial, sans-serif; margin: 0; background: #f9f9f9; }
  nav { background-color: #330000; padding: 1em; }
  .nav-list { display: flex; list-style: none; justify-content: center; gap: 1rem; padding:0; margin:0; }
  .nav-list li a { color:white; text-decoration:none; font-weight:bold; }
  .nav-list li a[aria-current="page"] { color: #ffcc00; }

  .container { display: flex; flex-wrap: wrap; padding: 1rem; gap: 1rem; }
  #map { flex:1; min-width: 400px; height: 600px; }
  .details { flex:1; min-width: 350px; background:white; border-radius:10px; padding:1rem; box-shadow:0 4px 12px rgba(0,0,0,0.08); max-height:600px; overflow:auto; }

  .details h2 { margin-top:0; }
  .search-box { margin-bottom:1rem; width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:5px; }

  table { width:100%; border-collapse: collapse; }
  th, td { border:1px solid #ddd; padding:0.5rem; font-size:0.9rem; text-align:left; }
  th { background:#f4f4f4; }

  tr:hover { background:#f9f9f9; }

  .dataset-link { color:#0077cc; text-decoration:none; }
  .dataset-link:hover { text-decoration:underline; }
</style>
</head>
<body>

<nav>
  <ul class="nav-list">
    <li><a href="index.html">Home</a></li>
    <li><a href="about.html">About</a></li>
    <li><a href="datasets.html" aria-current="page">Datasets</a></li>
    <li><a href="use-cases.html">Use Cases</a></li>
    <li><a href="resources.html">Resources</a></li>
    <li><a href="contribute.html">Contribute</a></li>
    <li><a href="contact.html">Contact</a></li>
  </ul>
</nav>

<div class="container">
  <div id="map"></div>
  <div class="details">
    <h2>Click a country</h2>
    <p>Total datasets: <span id="datasetCount">0</span></p>
    <input type="text" id="searchInput" class="search-box" placeholder="Search datasets...">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Domain</th>
          <th>Type</th>
          <th>Link</th>
        </tr>
      </thead>
      <tbody id="datasetTableBody"></tbody>
    </table>
  </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>

<script>
// Mapping CSV names to GeoJSON names if mismatched
const countryNameMap = {
  "democratic republic of the congo": "Democratic Republic of the Congo",
  "congo": "Republic of the Congo",
  "tanzania": "United Republic of Tanzania",
  "ivory coast": "Côte d'Ivoire",
  "swaziland": "Eswatini",
  "reunion": "Réunion",
  // add more as needed
};

function normalize(name) {
  return name.trim().toLowerCase();
}

// Load CSV
let catalogData = [];
Papa.parse("datasets/catalog.csv", {
  download: true,
  header: true,
  delimiter: "\t",
  complete: function(results) {
    catalogData = results.data.filter(d => d.Country); // remove empty rows
    initMap();
  }
});

// Initialize Choropleth Map
function initMap() {
  const width = 600, height = 600;
  const svg = d3.select("#map").append("svg").attr("width", width).attr("height", height);
  const projection = d3.geoMercator().center([20,0]).scale(400).translate([width/2, height/2]);
  const path = d3.geoPath().projection(projection);

  // Compute dataset counts per country
  const counts = {};
  catalogData.forEach(d => {
    let key = normalize(d.Country);
    if(countryNameMap[key]) key = normalize(countryNameMap[key]);
    counts[key] = (counts[key] || 0) + 1;
  });

  // Color scale
  const color = d3.scaleLinear()
    .domain([0, d3.max(Object.values(counts)) || 1])
    .range(["#fff5f0", "#990000"]);

  d3.json("datasets/africa.geojson").then(function(geojson) {
    svg.selectAll("path")
      .data(geojson.features)
      .enter()
      .append("path")
      .attr("d", path)
      .attr("fill", d => {
        const key = normalize(d.properties.name);
        return counts[key] ? color(counts[key]) : "#eee";
      })
      .attr("stroke", "#555")
      .on("click", function(event, d) {
        const countryKey = normalize(d.properties.name);
        const finalKey = countryNameMap[countryKey] ? normalize(countryNameMap[countryKey]) : countryKey;
        const datasets = catalogData.filter(row => {
          let rowKey = normalize(row.Country);
          if(countryNameMap[rowKey]) rowKey = normalize(countryNameMap[rowKey]);
          return rowKey === finalKey;
        });
        showCountryData(d.properties.name, datasets);
      });
  });
}

// Update right panel
function showCountryData(countryName, datasets) {
  document.querySelector(".details h2").textContent = countryName;
  document.getElementById("datasetCount").textContent = datasets.length;

  const tbody = document.getElementById("datasetTableBody");
  tbody.innerHTML = "";
  datasets.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d["Dataset Name"]}</td>
      <td>${d.Domain}</td>
      <td>${d["Data Type"]}</td>
      <td>${d.Link ? `<a href="${d.Link}" target="_blank" class="dataset-link">Open</a>` : "-"}</td>
    `;
    tbody.appendChild(tr);
  });
}

// Search filtering
document.getElementById("searchInput").addEventListener("input", function() {
  const search = this.value.toLowerCase();
  const rows = document.querySelectorAll("#datasetTableBody tr");
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(search) ? "" : "none";
  });
});
</script>

</body>
</html>
